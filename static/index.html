<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Scheduler</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body { font-family: sans-serif; }
        .container { max-width: 800px; margin: 2rem auto; padding: 1rem; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        input[type="text"] { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        button:hover { background-color: #45a049; }
        .error-message { color: red; margin-top: 0.5rem; }
        .success-message { color: green; margin-top: 0.5rem; }
        .warning-message { color: orange; margin-top: 0.5rem; }
        .webhook-item {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .webhook-details { flex-grow: 1; }
        .webhook-actions button {
            background-color: #dc3545;
            margin-left: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        .webhook-actions button:hover { background-color: #c82333; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container bg-white shadow-md rounded-lg">
        <h1 class="text-3xl font-bold mb-6 text-center">Generic Webhook Scheduler</h1>

        <div id="messages" class="mb-4"></div>

        <div class="warning-message p-3 rounded-md mb-4 border border-orange-400 bg-orange-100">
            <strong>Important:</strong> After adding or deleting a webhook, you must trigger a new deployment of this Deno Deploy project for the changes to take effect on the cron schedule.
        </div>

        <h2 class="text-2xl font-semibold mb-4">Add New Webhook</h2>
        <form id="add-webhook-form" class="mb-8">
            <div class="form-group">
                <label for="name">Webhook Name (e.g., Daily Content Sync):</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
                <label for="url">Webhook URL (e.g., https://api.example.com/webhook/trigger):</label>
                <input type="text" id="url" name="url" required>
            </div>
            <div class="form-group">
                <label for="schedule">Cron Schedule (UTC, e.g., 0 6 * * * for daily at 6 AM):</label>
                <input type="text" id="schedule" name="schedule" placeholder="0 6 * * *" required>
                <p class="text-sm text-gray-500 mt-1">
                    <a href="https://crontab.guru/" target="_blank" class="text-blue-500 hover:underline">Need help with cron syntax?</a>
                </p>
            </div>
            <button type="submit">Add Webhook</button>
        </form>

        <h2 class="text-2xl font-semibold mb-4">Scheduled Webhooks</h2>
        <div id="webhooks-list">
            <p>Loading webhooks...</p>
        </div>
    </div>

    <script>
        const messagesDiv = document.getElementById('messages');
        const addWebhookForm = document.getElementById('add-webhook-form');
        const webhooksListDiv = document.getElementById('webhooks-list');

        function showMessage(message, type) {
            messagesDiv.innerHTML = `<div class="${type}-message p-3 rounded-md mb-2">${message}</div>`;
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000); // Clear message after 5 seconds
        }

        async function fetchWebhooks() {
            try {
                const response = await fetch('/hooks');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const webhooks = await response.json();
                renderWebhooks(webhooks);
            } catch (error) {
                console.error('Error fetching webhooks:', error);
                showMessage('Failed to load webhooks. Please try again.', 'error');
                webhooksListDiv.innerHTML = '<p class="error-message">Error loading webhooks.</p>';
            }
        }

        function renderWebhooks(webhooks) {
            webhooksListDiv.innerHTML = '';
            if (webhooks.length === 0) {
                webhooksListDiv.innerHTML = '<p>No webhooks configured yet.</p>';
                return;
            }
            webhooks.forEach(webhook => {
                const webhookItem = document.createElement('div');
                webhookItem.className = 'webhook-item';
                webhookItem.innerHTML = `
                    <div class="webhook-details">
                        <strong class="text-lg">${webhook.name}</strong>
                        <p class="text-gray-700">${webhook.url}</p>
                        <p class="text-gray-600 text-sm">Schedule: <code>${webhook.schedule}</code></p>
                    </div>
                    <div class="webhook-actions">
                        <button class="delete-button" data-id="${webhook.id}">Delete</button>
                    </div>
                `;
                webhooksListDiv.appendChild(webhookItem);
            });

            // Attach event listeners for delete buttons
            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const idToDelete = event.target.dataset.id;
                    if (confirm(`Are you sure you want to delete "${idToDelete}"?`)) {
                        await deleteWebhook(idToDelete);
                    }
                });
            });
        }

        addWebhookForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(addWebhookForm);
            const name = formData.get('name').trim();
            const url = formData.get('url').trim();
            const schedule = formData.get('schedule').trim();

            if (!name || !url || !schedule) {
                showMessage('All fields are required.', 'error');
                return;
            }

            try {
                const response = await fetch('/hooks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, url, schedule }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                addWebhookForm.reset();
                showMessage('Webhook added successfully! Remember to redeploy for changes to take effect.', 'success');
                await fetchWebhooks(); // Refresh the list
            } catch (error) {
                console.error('Error adding webhook:', error);
                showMessage(`Failed to add webhook: ${error.message}`, 'error');
            }
        });

        async function deleteWebhook(id) {
            try {
                const response = await fetch(`/hooks/${id}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                showMessage('Webhook deleted successfully! Remember to redeploy for changes to take effect.', 'success');
                await fetchWebhooks(); // Refresh the list
            } catch (error) {
                console.error('Error deleting webhook:', error);
                showMessage(`Failed to delete webhook: ${error.message}`, 'error');
            }
        }

        // Initial fetch when the page loads
        document.addEventListener('DOMContentLoaded', fetchWebhooks);
    </script>
</body>
</html>